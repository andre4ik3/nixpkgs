From 47ab85a208cd06e492cacb76247c2ec9a799059e Mon Sep 17 00:00:00 2001
From: andre4ik3 <andre4ik3@fastmail.com>
Date: Wed, 11 Feb 2026 07:04:00 +0000
Subject: [PATCH] locale-util: allow overriding locale directory via
 environment

---
 docs/ENVIRONMENT.md     |  4 ++++
 src/basic/locale-util.c | 20 ++++++++++++++++----
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/docs/ENVIRONMENT.md b/docs/ENVIRONMENT.md
index fb2984b0ec..d99611da6a 100644
--- a/docs/ENVIRONMENT.md
+++ b/docs/ENVIRONMENT.md
@@ -388,6 +388,10 @@ All tools:
 * `$SYSTEMD_XKB_DIRECTORY=` — The directory must be absolute and normalized.
   If unset, the default XKB directory (/usr/share/X11/xkb) will be used.
 
+* `$SYSTEMD_LOCALE_DIRECTORY=` — The directory must be absolute and normalized.
+  If unset, the default locale directory of the C library (/usr/lib/locale for
+  glibc and /usr/share/i18n/locales/musl for musl) will be used.
+
 `systemd-resolved`:
 
 * `$SYSTEMD_RESOLVED_SYNTHESIZE_HOSTNAME` — if set to "0", `systemd-resolved`
diff --git a/src/basic/locale-util.c b/src/basic/locale-util.c
index 6e75299418..ca6a51f4c1 100644
--- a/src/basic/locale-util.c
+++ b/src/basic/locale-util.c
@@ -55,7 +55,14 @@ static char* normalize_locale(const char *name) {
         return strdup(name);
 }
 
+static const char* getenv_locale_dir(void) {
+        return secure_getenv("SYSTEMD_LOCALE_DIRECTORY");
+}
+
 #ifdef __GLIBC__
+
+#define DEFAULT_LOCALE_DIR "/usr/lib/locale/"
+
 static int add_locales_from_archive(Set *locales) {
         /* Stolen from glibc... */
 
@@ -94,7 +101,9 @@ static int add_locales_from_archive(Set *locales) {
 
         assert(locales);
 
-        _cleanup_close_ int fd = open("/usr/lib/locale/locale-archive", O_RDONLY|O_NOCTTY|O_CLOEXEC);
+        const char *locale_dir = getenv_locale_dir() ?: DEFAULT_LOCALE_DIR;
+        _cleanup_free_ char *locale_archive_file = path_join(locale_dir, "locale-archive");
+        _cleanup_close_ int fd = open(locale_archive_file, O_RDONLY|O_NOCTTY|O_CLOEXEC);
         if (fd < 0)
                 return errno == ENOENT ? 0 : -errno;
 
@@ -162,7 +171,7 @@ static int add_locales_from_libdir(Set *locales) {
 
         assert(locales);
 
-        dir = opendir("/usr/lib/locale");
+        dir = opendir(getenv_locale_dir() ?: DEFAULT_LOCALE_DIR);
         if (!dir)
                 return errno == ENOENT ? 0 : -errno;
 
@@ -186,12 +195,14 @@ static int add_locales_from_libdir(Set *locales) {
 
 #else
 
+#define DEFAULT_LOCALE_DIR "/usr/share/i18n/locales/musl/"
+
 static int add_locales_for_musl(Set *locales) {
         int r;
 
         assert(locales);
 
-        _cleanup_closedir_ DIR *dir = opendir("/usr/share/i18n/locales/musl/");
+        _cleanup_closedir_ DIR *dir = opendir(getenv_locale_dir() ?: DEFAULT_LOCALE_DIR);
         if (!dir)
                 return errno == ENOENT ? 0 : -errno;
 
@@ -313,7 +324,8 @@ int locale_is_installed(const char *name) {
 
         /* musl's newlocale() always succeeds and provides a fake locale object even when the locale does
          * not exist. Hence, we need to explicitly check if the locale file exists. */
-        _cleanup_free_ char *p = path_join("/usr/share/i18n/locales/musl/", name);
+        const char *locale_dir = getenv_locale_dir() ?: DEFAULT_LOCALE_DIR;
+        _cleanup_free_ char *p = path_join(locale_dir, name);
         if (!p)
                 return -ENOMEM;
 
-- 
2.52.0

